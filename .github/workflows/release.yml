name: Build and Release

on:
  push:
    branches:
      - master  # masterブランチへのマージ時
    tags:
      - '[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]*'  # 日付形式のタグ（YYYY-MM-DD または YYYY-MM-DD.1 など）
  workflow_dispatch:  # 手動実行も可能

jobs:
  create-tag:
    if: github.event_name == 'push' && github.ref == 'refs/heads/master' && !startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      tag: ${{ steps.tags.outputs.tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Get existing tags for today
        id: tags
        run: |
          DATE="${{ steps.date.outputs.date }}"
          git fetch --tags
          
          # 今日の日付で始まるタグを取得し、連番を確認
          EXISTING_TAGS=$(git tag -l "${DATE}*" | sort -V | tail -1)
          
          if [ -z "$EXISTING_TAGS" ]; then
            # 今日のタグが存在しない場合
            NEW_TAG="${DATE}"
          else
            # 最新のタグから連番を取得
            if [[ "$EXISTING_TAGS" =~ \.[0-9]+$ ]]; then
              # 既に連番が付いている場合（例: 2024-11-30.2）
              LAST_NUM=$(echo "$EXISTING_TAGS" | sed -E 's/.*\.([0-9]+)$/\1/')
              NEXT_NUM=$((LAST_NUM + 1))
              NEW_TAG="${DATE}.${NEXT_NUM}"
            else
              # 連番がない場合（例: 2024-11-30）
              NEW_TAG="${DATE}.1"
            fi
          fi
          
          echo "tag=${NEW_TAG}" >> $GITHUB_OUTPUT
          echo "Created tag: ${NEW_TAG}"

      - name: Create and push tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # [skip ci] を追加して、タグプッシュ時にワークフローが再実行されないようにする
          git tag -a "${{ steps.tags.outputs.tag }}" -m "Release ${{ steps.tags.outputs.tag }} [skip ci]"
          git push origin "${{ steps.tags.outputs.tag }}"

  build-tauri:
    needs: create-tag
    if: |
      always() && 
      (
        (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
        (needs.create-tag.result == 'success' || needs.create-tag.result == 'skipped')
      )
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'windows-latest'
            args: '--bundles nsis'
            target: 'windows'

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get tag name
        id: tag
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # タグから直接実行された場合
            TAG_NAME=${GITHUB_REF#refs/tags/}
          elif [[ "${{ needs.create-tag.result }}" == "success" ]]; then
            # create-tagジョブで作成されたタグを使用
            TAG_NAME="${{ needs.create-tag.outputs.tag }}"
          else
            # フォールバック: 最新のタグを取得
            git fetch --tags
            TAG_NAME=$(git describe --tags --abbrev=0 2>/dev/null || echo "dev")
          fi
          echo "tag=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "Building for tag: ${TAG_NAME}"

      - name: Install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-20.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.0-dev build-essential curl wget file libssl-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install frontend dependencies
        run: npm install

      - name: Generate Windows icon
        if: matrix.platform == 'windows-latest'
        run: |
          # Tauri CLIを使ってICOファイルを生成（Windowsビルドに必要）
          npx tauri icon src-tauri/icons/icon.png 2>&1 || echo "Icon generation skipped"
          # portable版でもicoファイルが生成されていることを確認
          if (Test-Path "src-tauri\icons\icon.ico") {
            echo "✅ icon.ico generated successfully"
          } else {
            echo "⚠️  icon.ico not found, but continuing..."
          }
        shell: pwsh

      - name: Configure bundle targets to exclude MSI
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          # MSI（wix）を除外して、NSISとportableのみを生成するように設定
          $config = Get-Content src-tauri/tauri.conf.json | ConvertFrom-Json
          # wixを無効化（既にnullだが、念のため）
          $config.bundle.windows.wix = $null
          # targetsを明示的に設定（MSIを除外）
          # Note: Tauri v2では"portable"はtargetsに直接指定できないため、
          # --bundles オプションで制御するか、wixを無効化することでMSIを除外
          $config | ConvertTo-Json -Depth 10 | Set-Content src-tauri/tauri.conf.json
          Write-Host "✅ Configured to exclude MSI bundle"

      - name: Build the app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: .
          args: ${{ matrix.args }}
          tagName: ${{ steps.tag.outputs.tag }}
          releaseName: 'Workflow Form ${{ steps.tag.outputs.tag }}'
          releaseBody: 'Release ${{ steps.tag.outputs.tag }} - Built on ${{ github.event.head_commit.timestamp || github.run_started_at }}'
          releaseDraft: false
          prerelease: false
